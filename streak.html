<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Streak Meter</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root { color-scheme: dark; }
    .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .no-select { -webkit-user-select: none; user-select: none; }
    @media (prefers-reduced-motion: reduce) {
      * { scroll-behavior: auto !important; transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body class="min-h-screen bg-zinc-950 text-zinc-100">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-b from-zinc-950 via-zinc-950 to-zinc-950"></div>
    <div class="absolute -top-32 left-1/2 h-[420px] w-[420px] -translate-x-1/2 rounded-full bg-indigo-600/20 blur-3xl"></div>
    <div class="absolute top-60 -left-20 h-[380px] w-[380px] rounded-full bg-emerald-500/15 blur-3xl"></div>
    <div class="absolute bottom-10 -right-20 h-[420px] w-[420px] rounded-full bg-fuchsia-500/10 blur-3xl"></div>
  </div>

  <!-- Setup Modal -->
  <div id="setupModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative w-full max-w-lg rounded-2xl border border-white/10 bg-zinc-950/70 p-6 shadow-2xl glass">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold">Set your start date</h2>
          <p class="mt-1 text-sm text-zinc-300">Everything stays on this device (local storage). You can change this later in Settings.</p>
        </div>
        <span class="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-zinc-200">Private</span>
      </div>

      <div class="mt-6 grid gap-4">
        <label class="grid gap-2">
          <span class="text-sm text-zinc-200">Start date</span>
          <input id="setupStartDate" type="date" class="w-full rounded-xl border border-white/10 bg-zinc-900/60 px-4 py-3 text-zinc-100 outline-none focus:border-indigo-400/60 focus:ring-2 focus:ring-indigo-400/20" />
          <span class="text-xs text-zinc-400">Tip: choose the first day you want your streak to count from.</span>
        </label>

        <button id="setupSaveBtn" class="rounded-xl bg-indigo-500 px-4 py-3 font-medium text-white shadow-sm hover:bg-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/30">Start tracking</button>
      </div>
    </div>
  </div>

  <header class="mx-auto max-w-6xl px-4 pt-10">
    <div class="flex flex-col gap-6 md:flex-row md:items-end md:justify-between">
      <div>
        <div class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-zinc-200">
          <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
          <span>Streak Meter</span>
        </div>
        <h1 class="mt-3 text-3xl font-semibold tracking-tight md:text-4xl"> MOMENTO</h1>
        <p class="mt-2 max-w-2xl text-sm text-zinc-300">you can you will</p>
      </div>

      <div class="flex flex-col gap-2 md:items-end">
        <div class="text-xs text-zinc-400">Today</div>
        <div id="todayLabel" class="text-lg font-medium"></div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 pb-16 pt-8">
    <!-- Top cards -->
    <section class="grid gap-4 md:grid-cols-12">
      <!-- Streak card -->
      <div class="md:col-span-7 rounded-2xl border border-white/10 bg-white/5 p-5 shadow-sm glass">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <div class="text-sm text-zinc-300">Current streak</div>
            <div class="mt-2 flex items-end gap-3">
              <div id="currentStreak" class="text-5xl font-semibold tracking-tight">—</div>
              <div class="pb-2 text-sm text-zinc-300">days</div>
            </div>
            <div id="streakSub" class="mt-2 text-sm text-zinc-300">—</div>
          </div>

          <div class="grid w-full gap-2 sm:w-auto">
            <div class="grid grid-cols-2 gap-2">
              <button id="markTodayBtn" class="rounded-xl bg-emerald-500 px-4 py-3 text-sm font-medium text-white hover:bg-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-400/30">Mark today ✓</button>
              <button id="resetTodayBtn" class="rounded-xl bg-rose-500 px-4 py-3 text-sm font-medium text-white hover:bg-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-400/30">Reset today</button>
            </div>
            <div class="flex items-center justify-between gap-3 rounded-xl border border-white/10 bg-zinc-950/40 px-4 py-3">
              <div>
                <div class="text-xs text-zinc-400">All-time best</div>
                <div id="bestStreak" class="text-sm font-medium">—</div>
              </div>
              <div>
                <div class="text-xs text-zinc-400">Start date</div>
                <div id="startDateLabel" class="text-sm font-medium">—</div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-5 grid gap-3 sm:grid-cols-3">
          <div class="rounded-xl border border-white/10 bg-zinc-950/40 p-4">
            <div class="text-xs text-zinc-400">This month</div>
            <div class="mt-1 text-sm"><span id="monthOnTrack" class="font-semibold">—</span> on-track days</div>
          </div>
          <div class="rounded-xl border border-white/10 bg-zinc-950/40 p-4">
            <div class="text-xs text-zinc-400">This month</div>
            <div class="mt-1 text-sm"><span id="monthResets" class="font-semibold">—</span> resets</div>
          </div>
          <div class="rounded-xl border border-white/10 bg-zinc-950/40 p-4">
            <div class="text-xs text-zinc-400">This month</div>
            <div class="mt-1 text-sm"><span id="monthBest" class="font-semibold">—</span> best run</div>
          </div>
        </div>
      </div>

      <!-- Quote card -->
      <div class="md:col-span-5 rounded-2xl border border-white/10 bg-white/5 p-5 shadow-sm glass">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm text-zinc-300">Motivation</div>
          </div>
          <button id="refreshQuoteBtn" class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs font-medium text-zinc-100 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-400/25">Refresh</button>
        </div>
        <div class="mt-4">
          <div id="quoteText" class="text-lg leading-snug">—</div>
          <div id="quoteAuthor" class="mt-3 text-sm text-zinc-300">—</div>
          <div id="quoteStatus" class="mt-2 text-xs text-zinc-500"></div>
        </div>
      </div>
    </section>

    <!-- Calendar + History -->
    <section class="mt-6 grid gap-4 lg:grid-cols-12">
      <!-- Calendar -->
      <div class="lg:col-span-7 rounded-2xl border border-white/10 bg-white/5 p-5 shadow-sm glass">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold">Monthly calendar</h2>
            <p class="mt-1 text-sm text-zinc-300">Tap a day to cycle: neutral → marked ✓ → reset → neutral.</p>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button id="prevMonthBtn" class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm hover:bg-white/10">←</button>
            <select id="monthSelect" class="min-w-[220px] rounded-xl border border-white/10 bg-zinc-900/60 px-3 py-2 text-sm outline-none focus:border-indigo-400/60 focus:ring-2 focus:ring-indigo-400/20"></select>
            <button id="nextMonthBtn" class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm hover:bg-white/10">→</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-7 gap-2 text-xs text-zinc-400">
          <div class="text-center">Mon</div><div class="text-center">Tue</div><div class="text-center">Wed</div><div class="text-center">Thu</div><div class="text-center">Fri</div><div class="text-center">Sat</div><div class="text-center">Sun</div>
        </div>

        <div id="calendarGrid" class="mt-2 grid grid-cols-7 gap-2"></div>

        <div class="mt-4 flex flex-wrap items-center gap-3 text-xs text-zinc-300">
          <div class="inline-flex items-center gap-2"><span class="h-3 w-3 rounded bg-zinc-800 ring-1 ring-white/10"></span><span>Neutral</span></div>
          <div class="inline-flex items-center gap-2"><span class="h-3 w-3 rounded bg-emerald-600"></span><span>Marked ✓</span></div>
          <div class="inline-flex items-center gap-2"><span class="h-3 w-3 rounded bg-rose-600"></span><span>Reset</span></div>
          <div class="inline-flex items-center gap-2"><span class="h-3 w-3 rounded bg-zinc-700/40 ring-1 ring-white/10"></span><span>Future (locked)</span></div>
        </div>
      </div>

      <!-- History/Settings -->
      <div class="lg:col-span-5 grid gap-4">
        <div class="rounded-2xl border border-white/10 bg-white/5 p-5 shadow-sm glass">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-lg font-semibold">Month-by-month</h2>
              <p class="mt-1 text-sm text-zinc-300">From your start month to now.</p>
            </div>
            <button id="jumpToStartBtn" class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs font-medium text-zinc-100 hover:bg-white/10">Jump to start</button>
          </div>

          <div class="mt-4 overflow-auto rounded-xl border border-white/10">
            <table class="min-w-full text-left text-sm">
              <thead class="bg-zinc-950/60 text-xs text-zinc-300">
                <tr>
                  <th class="px-3 py-2 font-medium">Month</th>
                  <th class="px-3 py-2 font-medium">Resets</th>
                  <th class="px-3 py-2 font-medium">Best run</th>
                  <th class="px-3 py-2 font-medium">Streak at end</th>
                </tr>
              </thead>
              <tbody id="historyTbody" class="divide-y divide-white/10 bg-zinc-950/30"></tbody>
            </table>
          </div>

          <div class="mt-3 text-xs text-zinc-400">Click a month row to open it in the calendar.</div>
        </div>

        <div class="rounded-2xl border border-white/10 bg-white/5 p-5 shadow-sm glass">
          <h2 class="text-lg font-semibold">Settings & backup</h2>
          <div class="mt-4 grid gap-3">
            <div class="grid gap-2">
              <label class="text-sm text-zinc-200">Start date</label>
              <div class="flex gap-2">
                <input id="startDateInput" type="date" class="w-full rounded-xl border border-white/10 bg-zinc-900/60 px-4 py-3 text-zinc-100 outline-none focus:border-indigo-400/60 focus:ring-2 focus:ring-indigo-400/20" />
                <button id="saveStartDateBtn" class="whitespace-nowrap rounded-xl bg-indigo-500 px-4 py-3 text-sm font-medium text-white hover:bg-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/30">Save</button>
              </div>
              <div class="text-xs text-zinc-400">Changing this will recalculate stats, but won’t delete your marked days.</div>
            </div>

            <div class="grid gap-2">
              <div class="flex flex-wrap gap-2">
                <button id="exportBtn" class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm hover:bg-white/10">Export</button>
                <label class="inline-flex cursor-pointer items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm hover:bg-white/10">
                  <input id="importInput" type="file" accept="application/json" class="hidden" />
                  Import
                </label>
                <button id="clearBtn" class="rounded-xl border border-rose-500/30 bg-rose-500/10 px-4 py-3 text-sm text-rose-200 hover:bg-rose-500/15">Clear all</button>
              </div>
              <div id="toast" class="hidden rounded-xl border border-white/10 bg-zinc-950/60 px-3 py-2 text-xs text-zinc-200"></div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <footer class="mt-10 text-xs text-zinc-500">
     
    </footer>
  </main>

  <script>
    // -----------------------------
    // Storage + Date helpers
    // -----------------------------
    const STORAGE_KEY = 'streak_meter_data_v1';

    function pad2(n) { return String(n).padStart(2, '0'); }

    function toLocalDateStr(d) {
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth() + 1);
      const dd = pad2(d.getDate());
      return `${yyyy}-${mm}-${dd}`;
    }

    function parseLocalDateStr(s) {
      // Create a Date at local midnight.
      const [y, m, d] = s.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function diffDays(a, b) {
      // a and b are Dates at local midnight
      const ms = b.getTime() - a.getTime();
      return Math.round(ms / 86400000);
    }

    function startOfMonth(year, monthIndex) { // monthIndex 0..11
      return new Date(year, monthIndex, 1);
    }

    function endOfMonth(year, monthIndex) {
      return new Date(year, monthIndex + 1, 0);
    }

    function clampDateStrToToday(dateStr) {
      const todayStr = toLocalDateStr(new Date());
      return dateStr > todayStr ? todayStr : dateStr;
    }

    function monthKey(year, monthIndex) {
      return `${year}-${pad2(monthIndex + 1)}`;
    }

    function monthLabel(year, monthIndex) {
      const d = new Date(year, monthIndex, 1);
      return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
    }

    function getMondayBasedWeekdayIndex(date) {
      // Return 0..6 where 0 = Monday
      const js = date.getDay(); // 0=Sun..6=Sat
      return (js + 6) % 7;
    }

    // -----------------------------
    // App state
    // -----------------------------
    const defaultData = {
      version: 1,
      startDate: '', // YYYY-MM-DD
      days: {},      // map YYYY-MM-DD -> 1 (marked) | -1 (reset)
      quoteCache: {
        date: '',
        content: '',
        author: '',
        source: ''
      }
    };

    let data = loadData();
    let selectedMonth = (() => {
      const now = new Date();
      return { year: now.getFullYear(), monthIndex: now.getMonth() };
    })();

    // -----------------------------
    // DOM
    // -----------------------------
    const el = {
      setupModal: document.getElementById('setupModal'),
      setupStartDate: document.getElementById('setupStartDate'),
      setupSaveBtn: document.getElementById('setupSaveBtn'),

      todayLabel: document.getElementById('todayLabel'),
      currentStreak: document.getElementById('currentStreak'),
      streakSub: document.getElementById('streakSub'),
      bestStreak: document.getElementById('bestStreak'),
      startDateLabel: document.getElementById('startDateLabel'),

      markTodayBtn: document.getElementById('markTodayBtn'),
      resetTodayBtn: document.getElementById('resetTodayBtn'),

      quoteText: document.getElementById('quoteText'),
      quoteAuthor: document.getElementById('quoteAuthor'),
      quoteStatus: document.getElementById('quoteStatus'),
      refreshQuoteBtn: document.getElementById('refreshQuoteBtn'),

      monthSelect: document.getElementById('monthSelect'),
      prevMonthBtn: document.getElementById('prevMonthBtn'),
      nextMonthBtn: document.getElementById('nextMonthBtn'),
      calendarGrid: document.getElementById('calendarGrid'),

      historyTbody: document.getElementById('historyTbody'),
      jumpToStartBtn: document.getElementById('jumpToStartBtn'),

      monthOnTrack: document.getElementById('monthOnTrack'),
      monthResets: document.getElementById('monthResets'),
      monthBest: document.getElementById('monthBest'),

      startDateInput: document.getElementById('startDateInput'),
      saveStartDateBtn: document.getElementById('saveStartDateBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importInput: document.getElementById('importInput'),
      clearBtn: document.getElementById('clearBtn'),
      toast: document.getElementById('toast')
    };

    // -----------------------------
    // Persistence
    // -----------------------------
    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultData);
        const parsed = JSON.parse(raw);
        const merged = { ...structuredClone(defaultData), ...parsed };
        merged.days = { ...(parsed.days || {}) };
        merged.quoteCache = { ...structuredClone(defaultData.quoteCache), ...(parsed.quoteCache || {}) };
        return merged;
      } catch {
        return structuredClone(defaultData);
      }
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // -----------------------------
    // Toast
    // -----------------------------
    let toastTimer = null;
    function showToast(msg) {
      el.toast.textContent = msg;
      el.toast.classList.remove('hidden');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.toast.classList.add('hidden'), 2500);
    }

    // -----------------------------
    // Streak logic
    // -----------------------------
    function isReset(dateStr) {
      return data.days?.[dateStr] === -1;
    }

    function isMarked(dateStr) {
      return data.days?.[dateStr] === 1;
    }

    function effectiveStartDateStr() {
      if (data.startDate) return data.startDate;
      // fallback if somehow missing: earliest marked day, else today
      const keys = Object.keys(data.days || {}).sort();
      return keys[0] || toLocalDateStr(new Date());
    }

    function lastResetOnOrBefore(refDateStr) {
      const startStr = effectiveStartDateStr();
      const start = parseLocalDateStr(startStr);
      const boundary = toLocalDateStr(addDays(start, -1));

      let last = boundary;
      for (const [d, v] of Object.entries(data.days || {})) {
        if (v !== -1) continue;
        if (d <= refDateStr && d > last) last = d;
      }
      // If start date moved later than last reset, keep boundary before start.
      if (last < boundary) last = boundary;
      return last;
    }

    function streakThrough(refDateStr) {
      const startStr = effectiveStartDateStr();
      const todayStr = toLocalDateStr(new Date());
      const clipped = refDateStr > todayStr ? todayStr : refDateStr;

      if (clipped < startStr) return 0;
      if (isReset(clipped)) return 0;

      const lastReset = lastResetOnOrBefore(clipped);
      const segStart = addDays(parseLocalDateStr(lastReset), 1);
      const segEnd = parseLocalDateStr(clipped);
      return diffDays(segStart, segEnd) + 1;
    }

    function bestStreakOverall() {
      const startStr = effectiveStartDateStr();
      const todayStr = toLocalDateStr(new Date());
      if (todayStr < startStr) return 0;

      // Build sorted reset list within [start..today]
      const resets = Object.entries(data.days || {})
        .filter(([d, v]) => v === -1 && d >= startStr && d <= todayStr)
        .map(([d]) => d)
        .sort();

      let best = 0;
      let segmentStart = parseLocalDateStr(startStr);

      for (const r of resets) {
        const resetDate = parseLocalDateStr(r);
        const segmentEnd = addDays(resetDate, -1);
        if (segmentEnd >= segmentStart) {
          best = Math.max(best, diffDays(segmentStart, segmentEnd) + 1);
        }
        segmentStart = addDays(resetDate, 1);
      }

      const lastEnd = parseLocalDateStr(todayStr);
      if (lastEnd >= segmentStart) best = Math.max(best, diffDays(segmentStart, lastEnd) + 1);

      return best;
    }

    function monthStats(year, monthIndex) {
      const startStr = effectiveStartDateStr();
      const todayStr = toLocalDateStr(new Date());
      const mStart = startOfMonth(year, monthIndex);
      const mEnd = endOfMonth(year, monthIndex);
      const rangeStartStr = toLocalDateStr(mStart);
      const rangeEndStr = toLocalDateStr(mEnd);

      const effectiveRangeStartStr = rangeStartStr < startStr ? startStr : rangeStartStr;
      const effectiveRangeEndStr = rangeEndStr > todayStr ? todayStr : rangeEndStr;

      const totalDaysInRange = effectiveRangeEndStr >= effectiveRangeStartStr
        ? diffDays(parseLocalDateStr(effectiveRangeStartStr), parseLocalDateStr(effectiveRangeEndStr)) + 1
        : 0;

      let resets = 0;
      let marked = 0;
      let bestRun = 0;

      if (totalDaysInRange > 0) {
        // Iterate day by day for best run and counts (future excluded).
        let run = 0;
        let cursor = parseLocalDateStr(effectiveRangeStartStr);
        for (let i = 0; i < totalDaysInRange; i++) {
          const ds = toLocalDateStr(cursor);
          const v = data.days?.[ds] || 0;
          if (v === -1) {
            resets++;
            run = 0;
          } else {
            run++;
            if (v === 1) marked++;
            bestRun = Math.max(bestRun, run);
          }
          cursor = addDays(cursor, 1);
        }
      }

      // Streak at end of month (or end of range if current month)
      const streakAtEnd = (effectiveRangeEndStr && effectiveRangeEndStr >= effectiveRangeStartStr)
        ? streakThrough(effectiveRangeEndStr)
        : 0;

      // Note: "on-track" days shown here = days not marked reset within the effective range.
      const onTrack = totalDaysInRange - resets;

      return { totalDaysInRange, onTrack, resets, marked, bestRun, streakAtEnd, effectiveRangeStartStr, effectiveRangeEndStr };
    }

    function monthsFromStartToNow() {
      const startStr = effectiveStartDateStr();
      const start = parseLocalDateStr(startStr);
      const now = new Date();
      const months = [];

      let y = start.getFullYear();
      let m = start.getMonth();

      while (y < now.getFullYear() || (y === now.getFullYear() && m <= now.getMonth())) {
        months.push({ year: y, monthIndex: m });
        m++;
        if (m > 11) { m = 0; y++; }
      }
      return months;
    }

    // -----------------------------
    // Quote API
    // -----------------------------
    const fallbackQuotes = [
      { content: 'Small steps, consistently repeated, create big change.', author: 'Unknown' },
      { content: 'Discipline is choosing what you want most over what you want now.', author: 'Unknown' },
      { content: 'You don\'t rise to the level of your goals; you fall to the level of your systems.', author: 'James Clear' },
      { content: 'Focus on the next right action.', author: 'Unknown' },
      { content: 'A calm mind is a powerful mind.', author: 'Unknown' }
    ];

    async function fetchQuote(force = false) {
      const todayStr = toLocalDateStr(new Date());
      if (!force && data.quoteCache?.date === todayStr && data.quoteCache?.content) {
        setQuote(data.quoteCache.content, data.quoteCache.author, `Cached for today (${data.quoteCache.source || 'local'})`);
        return;
      }

      el.quoteStatus.textContent = 'Loading…';
      try {
        // Quotable is widely used, but availability can vary; we keep a local fallback.
        const res = await fetch('https://api.quotable.io/random', { cache: 'no-store' });
        if (!res.ok) throw new Error('Quote API error');
        const j = await res.json();
        const content = j?.content?.trim();
        const author = j?.author?.trim() || 'Unknown';
        if (!content) throw new Error('Invalid quote');

        data.quoteCache = { date: todayStr, content, author, source: 'api.quotable.io' };
        saveData();
        setQuote(content, author, 'Live from api.quotable.io');
      } catch (e) {
        const pick = fallbackQuotes[Math.floor(Math.random() * fallbackQuotes.length)];
        data.quoteCache = { date: todayStr, content: pick.content, author: pick.author, source: 'local fallback' };
        saveData();
        setQuote(pick.content, pick.author, '');
      }
    }

    function setQuote(content, author, status) {
      el.quoteText.textContent = `“${content}”`;
      el.quoteAuthor.textContent = `— ${author}`;
      el.quoteStatus.textContent = status || '';
    }

    // -----------------------------
    // Rendering
    // -----------------------------
    function renderTodayLabel() {
      const now = new Date();
      el.todayLabel.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    function renderTopStats() {
      const startStr = effectiveStartDateStr();
      const todayStr = toLocalDateStr(new Date());

      const current = streakThrough(todayStr);
      el.currentStreak.textContent = String(current);

      const lastReset = lastResetOnOrBefore(todayStr);
      const lastResetPretty = lastReset === toLocalDateStr(addDays(parseLocalDateStr(startStr), -1))
        ? 'none'
        : new Date(parseLocalDateStr(lastReset)).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });

      const todayState = isReset(todayStr) ? 'reset' : (isMarked(todayStr) ? 'marked ✓' : 'neutral');

      el.streakSub.textContent = `Today: ${todayState}. Last reset: ${lastResetPretty}.`;
      el.bestStreak.textContent = `${bestStreakOverall()} days`;

      el.startDateLabel.textContent = new Date(parseLocalDateStr(startStr)).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });

      // This month quick stats
      const now = new Date();
      const ms = monthStats(now.getFullYear(), now.getMonth());
      el.monthOnTrack.textContent = String(ms.onTrack);
      el.monthResets.textContent = String(ms.resets);
      el.monthBest.textContent = `${ms.bestRun} days`;
    }

    function renderMonthSelect() {
      const months = monthsFromStartToNow();
      const currentKey = monthKey(selectedMonth.year, selectedMonth.monthIndex);

      el.monthSelect.innerHTML = '';
      for (const m of months) {
        const opt = document.createElement('option');
        opt.value = monthKey(m.year, m.monthIndex);
        opt.textContent = monthLabel(m.year, m.monthIndex);
        if (opt.value === currentKey) opt.selected = true;
        el.monthSelect.appendChild(opt);
      }

      // If selected month is before start (possible after changing start date), snap.
      const startStr = effectiveStartDateStr();
      const start = parseLocalDateStr(startStr);
      const startKey = monthKey(start.getFullYear(), start.getMonth());
      if (!months.some(x => monthKey(x.year, x.monthIndex) === currentKey)) {
        selectedMonth = { year: start.getFullYear(), monthIndex: start.getMonth() };
        el.monthSelect.value = startKey;
      }
    }

    function renderCalendar() {
      const { year, monthIndex } = selectedMonth;
      const todayStr = toLocalDateStr(new Date());

      const mStart = startOfMonth(year, monthIndex);
      const mEnd = endOfMonth(year, monthIndex);
      const daysInMonth = mEnd.getDate();
      const offset = getMondayBasedWeekdayIndex(mStart); // blanks before day 1

      el.calendarGrid.innerHTML = '';

      // leading blanks
      for (let i = 0; i < offset; i++) {
        const blank = document.createElement('div');
        blank.className = 'h-11 rounded-xl border border-white/5 bg-white/0';
        el.calendarGrid.appendChild(blank);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const d = new Date(year, monthIndex, day);
        const ds = toLocalDateStr(d);
        const v = data.days?.[ds] || 0;

        const isToday = ds === todayStr;
        const isFuture = ds > todayStr;

        let cls = 'h-11 rounded-xl px-2 text-sm flex items-center justify-center no-select transition-colors ring-1 ring-white/10 ';
        let title = '';

        if (isFuture) {
          cls += 'bg-zinc-700/30 text-zinc-300 cursor-not-allowed';
          title = 'Future day';
        } else if (v === -1) {
          cls += 'bg-rose-600 text-white hover:bg-rose-500 cursor-pointer';
          title = 'Reset (click to change)';
        } else if (v === 1) {
          cls += 'bg-emerald-600 text-white hover:bg-emerald-500 cursor-pointer';
          title = 'Marked ✓ (click to change)';
        } else {
          cls += 'bg-zinc-800/60 text-zinc-100 hover:bg-zinc-700/60 cursor-pointer';
          title = 'Neutral (click to change)';
        }

        if (isToday) cls += ' ring-2 ring-indigo-400/60';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = cls;
        btn.textContent = String(day);
        btn.title = title;
        btn.setAttribute('aria-label', `${ds} ${v === -1 ? 'reset' : (v === 1 ? 'marked' : 'neutral')}`);

        if (!isFuture) {
          btn.addEventListener('click', () => {
            // Cycle: 0 -> 1 -> -1 -> 0
            const cur = data.days?.[ds] || 0;
            let next = 0;
            if (cur === 0) next = 1;
            else if (cur === 1) next = -1;
            else next = 0;

            if (next === 0) delete data.days[ds];
            else data.days[ds] = next;

            saveData();
            renderAll();
          });
        }

        el.calendarGrid.appendChild(btn);
      }
    }

    function renderHistoryTable() {
      const months = monthsFromStartToNow();
      const selectedKey = monthKey(selectedMonth.year, selectedMonth.monthIndex);

      el.historyTbody.innerHTML = '';

      for (let i = months.length - 1; i >= 0; i--) {
        const m = months[i];
        const key = monthKey(m.year, m.monthIndex);
        const stats = monthStats(m.year, m.monthIndex);

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/5 cursor-pointer';
        if (key === selectedKey) tr.classList.add('bg-white/5');

        const tdMonth = document.createElement('td');
        tdMonth.className = 'px-3 py-2 whitespace-nowrap';
        tdMonth.textContent = monthLabel(m.year, m.monthIndex);

        const tdResets = document.createElement('td');
        tdResets.className = 'px-3 py-2';
        tdResets.textContent = String(stats.resets);

        const tdBest = document.createElement('td');
        tdBest.className = 'px-3 py-2';
        tdBest.textContent = `${stats.bestRun}`;

        const tdEnd = document.createElement('td');
        tdEnd.className = 'px-3 py-2';
        tdEnd.textContent = `${stats.streakAtEnd}`;

        tr.appendChild(tdMonth);
        tr.appendChild(tdResets);
        tr.appendChild(tdBest);
        tr.appendChild(tdEnd);

        tr.addEventListener('click', () => {
          selectedMonth = { year: m.year, monthIndex: m.monthIndex };
          renderMonthSelect();
          renderCalendar();
          renderHistoryTable();
        });

        el.historyTbody.appendChild(tr);
      }
    }

    function renderStartDateInputs() {
      const startStr = effectiveStartDateStr();
      el.startDateInput.value = startStr;
    }

    function ensureSetup() {
      if (data.startDate) {
        el.setupModal.classList.add('hidden');
        el.setupModal.classList.remove('flex');
        return;
      }
      const todayStr = toLocalDateStr(new Date());
      el.setupStartDate.value = todayStr;
      el.setupModal.classList.remove('hidden');
      el.setupModal.classList.add('flex');
    }

    function renderAll() {
      renderTodayLabel();
      renderTopStats();
      renderMonthSelect();
      renderCalendar();
      renderHistoryTable();
      renderStartDateInputs();
    }

    // -----------------------------
    // Events
    // -----------------------------
    el.setupSaveBtn.addEventListener('click', () => {
      const v = el.setupStartDate.value;
      if (!v) return;
      data.startDate = v;
      saveData();
      ensureSetup();
      // Snap selected month to start month
      const sd = parseLocalDateStr(v);
      selectedMonth = { year: sd.getFullYear(), monthIndex: sd.getMonth() };
      renderAll();
      fetchQuote(false);
      showToast('Start date saved.');
    });

    el.markTodayBtn.addEventListener('click', () => {
      const todayStr = toLocalDateStr(new Date());
      if (isReset(todayStr)) {
        const ok = confirm('Today is marked as a reset. Change it to “marked ✓” instead?');
        if (!ok) return;
      }
      data.days[todayStr] = 1;
      saveData();
      renderAll();
      showToast('Marked today ✓');
    });

    el.resetTodayBtn.addEventListener('click', () => {
      const todayStr = toLocalDateStr(new Date());
      const ok = confirm('Mark today as a reset? This will set the current streak to 0 for today.');
      if (!ok) return;
      data.days[todayStr] = -1;
      saveData();
      renderAll();
      showToast('Marked today as reset');
    });

    el.refreshQuoteBtn.addEventListener('click', () => fetchQuote(true));

    el.monthSelect.addEventListener('change', (e) => {
      const val = e.target.value; // YYYY-MM
      const [y, m] = val.split('-').map(Number);
      selectedMonth = { year: y, monthIndex: m - 1 };
      renderCalendar();
      renderHistoryTable();
    });

    el.prevMonthBtn.addEventListener('click', () => {
      const months = monthsFromStartToNow();
      const keys = months.map(m => monthKey(m.year, m.monthIndex));
      const cur = monthKey(selectedMonth.year, selectedMonth.monthIndex);
      const idx = keys.indexOf(cur);
      if (idx > 0) {
        const m = months[idx - 1];
        selectedMonth = { year: m.year, monthIndex: m.monthIndex };
        renderMonthSelect();
        renderCalendar();
        renderHistoryTable();
      }
    });

    el.nextMonthBtn.addEventListener('click', () => {
      const months = monthsFromStartToNow();
      const keys = months.map(m => monthKey(m.year, m.monthIndex));
      const cur = monthKey(selectedMonth.year, selectedMonth.monthIndex);
      const idx = keys.indexOf(cur);
      if (idx >= 0 && idx < months.length - 1) {
        const m = months[idx + 1];
        selectedMonth = { year: m.year, monthIndex: m.monthIndex };
        renderMonthSelect();
        renderCalendar();
        renderHistoryTable();
      }
    });

    el.jumpToStartBtn.addEventListener('click', () => {
      const sd = parseLocalDateStr(effectiveStartDateStr());
      selectedMonth = { year: sd.getFullYear(), monthIndex: sd.getMonth() };
      renderMonthSelect();
      renderCalendar();
      renderHistoryTable();
      showToast('Jumped to start month.');
    });

    el.saveStartDateBtn.addEventListener('click', () => {
      const v = el.startDateInput.value;
      if (!v) return;
      const ok = confirm('Save new start date? Stats will be recalculated.');
      if (!ok) {
        renderStartDateInputs();
        return;
      }
      data.startDate = v;
      saveData();
      const sd = parseLocalDateStr(v);
      selectedMonth = { year: sd.getFullYear(), monthIndex: sd.getMonth() };
      renderAll();
      showToast('Start date updated.');
    });

    el.exportBtn.addEventListener('click', () => {
      const payload = JSON.stringify(data, null, 2);
      const blob = new Blob([payload], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `streak-meter-backup-${toLocalDateStr(new Date())}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('Exported backup JSON.');
    });

    el.importInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        if (!parsed || typeof parsed !== 'object') throw new Error('Invalid file');

        // Basic merge/validation
        const next = { ...structuredClone(defaultData), ...parsed };
        next.days = { ...(parsed.days || {}) };
        next.quoteCache = { ...structuredClone(defaultData.quoteCache), ...(parsed.quoteCache || {}) };

        data = next;
        saveData();
        ensureSetup();
        // Snap selection safely
        const sd = parseLocalDateStr(effectiveStartDateStr());
        selectedMonth = { year: sd.getFullYear(), monthIndex: sd.getMonth() };
        renderAll();
        showToast('Imported backup.');
      } catch {
        showToast('Import failed (invalid JSON).');
      } finally {
        e.target.value = '';
      }
    });

    el.clearBtn.addEventListener('click', () => {
      const ok = confirm('Clear everything from this device?');
      if (!ok) return;
      data = structuredClone(defaultData);
      saveData();
      ensureSetup();
      renderAll();
      showToast('Cleared local data.');
    });

    // -----------------------------
    // Init
    // -----------------------------
    (function init() {
      ensureSetup();
      // If we already have a start date, snap selected month to current (or start if current is earlier).
      if (data.startDate) {
        const start = parseLocalDateStr(effectiveStartDateStr());
        const now = new Date();
        const nowKey = monthKey(now.getFullYear(), now.getMonth());
        const startKey = monthKey(start.getFullYear(), start.getMonth());
        // Keep selected month as now, unless now is before start.
        if (nowKey < startKey) selectedMonth = { year: start.getFullYear(), monthIndex: start.getMonth() };
      }

      renderAll();
      fetchQuote(false);
    })();
  </script>
</body>
</html>
